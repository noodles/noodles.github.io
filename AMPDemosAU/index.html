<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,user-scalable=no" />
  <title>AMP Demos</title>
<!--   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114121901-1"></script> -->
  <script src="idb.js"></script>
<!--   <script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'UA-114121901-1', { 'page_title': 'AMP Demos v4' });
  </script> -->
  <style>
  body {
    margin: 20px;
  }
  .container {
    font-size: 1rem;
    margin: 0px;
  }
  hr {
    margin: 25px 0px;
  }
  input {
    font-size: 14px;
    padding: 5px 10px;
  }
  .row {
    display: flex;
    flex-flow: row nowrap;
    margin: 10px 0px 15px 0px;
  }
  .label {
    flex: 0 0 175px;
    font-weight: bold;
  }
  .output {
    flex: 0 0 125px;
  }
  .entry {
    flex: 1;
    overflow-wrap: break-word;
    word-wrap: break-word;
  }
  .wptlink {
    flex: 0 0 75px;
    font-size: .8rem;
  }
  .textEntry {
    border: .2px solid #b9b9b9;
    max-width: 800px;
  }
  .mytests {
    text-align: center;
  }
  input[type="submit"] {
    font-size: 1em;
    padding: 8px 15px;
    border-radius: 5px;
  }
  h2 {
    margin: 5px 0px 20px 0px;
  }
  a {
    word-break: break-word;
  }
  #wptiframe {
    width: 100%;
    height: 1200px;
  }
  #instructions {
    margin: 30px 0px 5px 0px;
  }
  #instruction {
    margin-left: 10px;
  }
  #output,
  #mytests {
    display: none;
  }
  #collapse-script {
    display: none;
  }
  #toggle {
    width: 100%;
    height: 20px;
    cursor: pointer;
    display: flex;
  }
  #script {
    padding: 15px;
    display: none;
    background-color: lightgray;
    max-width: 1000px;
  }
  #togglesvg {
    width: 20px;
    height: 20px;
    margin: 0px 5px;
  }
  #togglesvg[expanded=true] {
    transform: rotate(90deg) translate(0, 0);
  }
  @media(max-width: 500px) {
    body {
      margin: 10px;
    }
    .container {
      margin: 0px;
    }
    .row {
      display: flex;
      flex-flow: row wrap;
      margin: 10px 0px 15px 0px;
    }
    .label {
      flex: 1 100%;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .entry {
      flex: 1 100%;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    .mytests {
      text-align: left;
    }
    #script {
      padding: 10px;
      max-width: calc(100vw - 50px);
    }
  }
  .tooltip {
    position: relative;
    display: inline-block;
    border-bottom: 1px dotted black;
  }
  .tooltip .tooltiptext {
    visibility: hidden;
    width: 400px;
    background-color: black;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px 0;
    font-size: 16px;
    font-weight: normal;
    padding: 5px;
    /* Position the tooltip */
    position: absolute;
    z-index: 1;
  }
  .tooltip:hover .tooltiptext {
    visibility: visible;
  }
  </style>
</head>

<body>
  <h1>AMP Demos</h1>
  <form id="inputUrls" class="container" method="post">
    <div class="row">
      <label class="label" for="wptApiKey">
        <span class="tooltip">WebpageTest API Key
          <span class="tooltiptext">Your private API Key.
            <a href="
http://www.webpagetest.org/getkey.php" style="color: #96fff2; font-weight: bold;" target="_blank">Click here</a> to request a key.</span>
      </label>
      <input type="text" id="wptApiKey" class="entry textEntry" name="wptApiKey" required placeholder="YOUR-PRIVATE-API-KEY">
    </div>

    <div class="row">
      <label class="label" for="canonicalURL">
        <span class="tooltip">Canonical URL
          <span class="tooltiptext">Enter the non-AMP URL</span>
      </label>
      <input type="url" required class="entry textEntry" id="canonicalURL" name="canonicalURL" placeholder="https://ideas.mercadolibre.com/ar/">
    </div>

    <div class="row">
      <label class="label" for="searchTerm">
        <span class="tooltip">Google Search Term
          <span class="tooltiptext">Enter a Google search term that returns the AMP page in the first page of results. You can limit results to a domain by adding "site:domain.com". Often, the canonical URL as the search term works.</span>
      </label>
      <input type="text" id="searchTerm" class="entry textEntry" name="searchTerm" required placeholder="ideas mercado libre argentina site:mercadolibre.com">
    </div>

    <div class="row">
      <label class="label">Connection Type</label>
      <div class="entry">
        <input type="radio" id="connectionChoice1" name="connectionType" value="2G">2G
        <input type="radio" id="connectionChoice2" name="connectionType" value="3G" checked>3G
        <input type="radio" id="connectionChoice3" name="connectionType" value="4G">4G
      </div>
    </div>

    <div class="row">
      <label class="label">Location</label>
      <div class="entry">
        <select name="location" id="location-dropdown">
          <option value="Dulles">Dulles</option>
          <option value="ec2-ap-southeast-2" selected>Sydney</option>
        </select>
      </div>
    </div>

    <div class="row">
      <label class="label">Videos</label>
      <div class="entry">
        <input class="checkbox" checked type="checkbox" name="videoCheck" id="videoCheck1" value="canonical">
        <label for="videoCheck1">Canonical</label>
        <input class="checkbox" checked type="checkbox" name="videoCheck" id="videoCheck2" value="origin">
        <label for="videoCheck2">
          <span class="tooltip">AMP Origin
            <span class="tooltiptext">AMP loaded from origin</span>
        </label>
        <input class="checkbox" checked type="checkbox" name="videoCheck" id="videoCheck3" value="cache">
        <label for="videoCheck3">
          <span class="tooltip">AMP Cache
            <span class="tooltiptext">AMP page loaded from the AMP Cache</span>
        </label>
        <input class="checkbox" checked type="checkbox" name="videoCheck" id="videoCheck4" value="serp">
        <label for="videoCheck4">
          <span class="tooltip">AMP SERP
            <span class="tooltiptext">How the AMP page loads for a user coming from Google Search (e.g. prefetching applied). This is the experience users get.</span>
        </label>
      </div>
    </div>
    <input type="submit" value="Create Video"> </form>
  <hr/>

  <div id="mytests">
    <h2>Test History</h2>
    <div class="container" id="mytestsContainer"></div>
    <hr/>
  </div>

  <div id="output">
    <div class="container">
      <h2>Output</h2>
      <div class="row">
        <div class="label output">Canonical</div>
        <div class="wptlink" id="canonicalWPTLink"></div>
        <div class="entry" id="canonicalUrl"></div>
      </div>
      <div class="row">
        <div class="label output">AMP Origin</div>
        <div class="wptlink" id="originWPTLink"></div>
        <div class="entry" id="originUrl"></div>
      </div>
      <div class="row">
        <div class="label output">AMP Cache</div>
        <div class="wptlink" id="cacheWPTLink"></div>
        <div class="entry" id="cacheUrl"></div>
      </div>
      <div class="row">
        <div class="label output">AMP SERP</div>
        <div class="wptlink" id="serpWPTLink"></div>
        <div class="entry">
          <div id="collapse-script">
            <div id="toggle" collapsed>
              <svg id="togglesvg" width="100" height="100" viewBox="-25 0 100 100" preserveAspectRatio>
                <polygon points="0,80 50,40 0,0" id="togglesvg" />
              </svg>
              <text>View WebpageTest Script</text>
            </div>
            <code id="script"></code>
          </div>
        </div>
      </div>
    </div>
    <p id="instructions">
      <a id="comparisonLink" target="_blank">WPT Comparison Link</a>
      <span id="instruction">(Click "Create Video" when tests are finished running)</span>
    </p>
    <iframe id="wptiframe"></iframe>
  </div>

  <script>
    
    let dropdown = document.getElementById('location-dropdown');
dropdown.length = 0;

let defaultOption = document.createElement('option');
defaultOption.text = 'Choose Server Location';

dropdown.add(defaultOption);
dropdown.selectedIndex = 0;

const url = 'https://www.webpagetest.org/getLocations.php?f=json&k=A';

const request = new XMLHttpRequest();
request.open('GET', url, true);

request.onload = function() {
  if (request.status === 200) {
    const data = JSON.parse(request.responseText);
    let option;
    for (let i = 0; i < data.length; i++) {
      option = document.createElement('option');
      option.text = data[i].Label;
      option.value = data[i].location;
      dropdown.add(option);
    }
   } else {
    // Reached the server, but it returned an error
  }   
}

request.onerror = function() {
  console.error('An error occurred fetching the JSON from ' + url);
};

request.send();
  var RUNS = 1;
  var AMP_BATCH_URL = 'https://acceleratedmobilepageurl.googleapis.com/v1/ampUrls:batchGet';
  var AMP_BATCH_API_KEY = 'AIzaSyDteMhzKv7HPdYx2zV4nyiQ3bbCdDoTMbM';
  var dbPromise = idb.open('AMPDemos', 3, (function(upgradeDb) {
    if (!upgradeDb.objectStoreNames.contains('Tests')) {
      var queuedRequests = upgradeDb.createObjectStore('Tests', {
        unique: true,
        autoIncrement: true,
        keyPath: 'id',
      });
    }
    if (!upgradeDb.objectStoreNames.contains('API_Keys')) {
      upgradeDb.createObjectStore('API_Keys', {
        unique: true,
        // autoIncrement: true,
        keyPath: 'keyType',
      });
    }
  }));
  function recordClick(_url) {
    gtag('event', 'View Past Test', {
      'event_category': 'Test History',
      'event_label': _url
    });
  }
  // get test history
  function getTests() {
    dbPromise.then(db => db.transaction('Tests', 'readonly').objectStore('Tests').getAll()).then(items => {
      let mytestsContainer = document.getElementById('mytestsContainer');
      if (items.length > 0) {
        document.getElementById('mytests').style.display = "block";
        for (let i = 0; i < items.length; i++) {
          let row = document.createElement('div');
          row.classList = "row";
          row.innerHTML = `
                          <div class="label mytests"><a href='${items[i].wptLink}' target="_blank" onclick="recordClick('${items[i].wptLink}');">Test ${i+1}</a></div>
                          <div class="entry">${items[i].url}</div>`;
          mytestsContainer.appendChild(row);
        }
      }
    });
  }
  getTests();
  // save test to IndexedDB
  function saveTest(url, wptLink) {
    dbPromise.then(db => db.transaction('Tests', 'readwrite').objectStore('Tests').add({ url: url, wptLink: wptLink }).complete);
  }
  // save API KEY to IndexedDB
  function saveWPTAPIKey(wptApiKey) {
    dbPromise.then(db => db.transaction('API_Keys', 'readwrite').objectStore('API_Keys').add({ keyType: 'WPT', apiKey: wptApiKey }).complete);
  }
  // get WPT API key if it exists
  function getWPTAPIKey() {
    dbPromise.then(db => db.transaction('API_Keys', 'readonly').objectStore('API_Keys').get('WPT')).then(key => {
      if (key)
        document.getElementById('wptApiKey').value = key.apiKey;
    });
  }
  getWPTAPIKey();
  var toggle = document.getElementById('toggle');
  var toggleSvg = document.getElementById('togglesvg');
  var scriptBox = document.getElementById('script');
  var expanded = false;
  toggle.addEventListener('click', (e) => {
    console.log('clicked');
    scriptBox.style.display = expanded ? "none" : "block";
    toggleSvg.setAttribute("expanded", !expanded);
    expanded = !expanded;
  });
  // run WPT
  function runWPT(url, connection, name, api_key) {
    return fetch(`https://www.webpagetest.org/runtest.php?k=${api_key}&url=${encodeURIComponent(url)}&f=json&runs=${RUNS}&fvonly=1&video=1&mobile=1&location=Dulles%3AChrome.${connection}`, {
      'method': 'GET',
    }).then(response => response.text()).then(json => {
      return {
        name: name,
        id: JSON.parse(json).data.testId
      };
    });
  }
  // run scripted WPT
  function runScriptedWPT(searchTerm, ampUrl, connection, name, api_key) {
    let script =
      `logData    0
navigate    https://www.google.com/search?q=${encodeURIComponent(searchTerm)}
sleep   3
exec    window.scrollBy(0, 400);
sleep   2
exec    window.scrollBy(0, 400);
sleep   2
exec    window.scrollBy(0, 400);
sleep   2
exec    window.scrollBy(0, 400);
sleep   2
exec    window.scrollBy(0, 400);
sleep   2
exec    window.scrollBy(0, 400);
sleep   5
logData 1
execAndWait document.querySelector("a[href='${ampUrl}'").click();`;
    document.getElementById('collapse-script').style.display = 'block';
    document.getElementById('script').innerText = script;
    return fetch(`https://www.webpagetest.org/runtest.php?k=${api_key}&f=json&runs=${RUNS}&fvonly=1&video=1&mobile=1&location=ec2-ap-southeast-2%3AChrome.${connection}&script=${encodeURIComponent(script)}`).then(response => response.text()).then(json => {
      return {
        name: name,
        id: JSON.parse(json).data.testId
      };
    });
  }
  // call AMP URL API to get AMP and AMP Cache URLs given canonical URL
  function callAMPBatchURLAPI(url) {
    return fetch(`${AMP_BATCH_URL}?key=${AMP_BATCH_API_KEY}`, {
      'body': `{"urls":["${url}"]}`,
      method: 'POST',
      headers: new Headers([
        ['Content-Type', 'application/json']
      ]),
    }).then(response => response.json());
  }
  var urlInput = document.getElementById("canonicalURL");
  var AMPUrlsJson;
  // check to make sure canonical URL has AMP equivalent as soon as user enters it
  urlInput.addEventListener('change', (e) => {
    urlInput.setCustomValidity("Checking if URL is valid, try again in a moment");
    callAMPBatchURLAPI(urlInput.value).then(json => {
      AMPUrlsJson = json;
      if (json["urlErrors"])
        urlInput.setCustomValidity("Did not find AMP version. Enter a URL with an AMP equivalent.");
      else
        urlInput.setCustomValidity('');
    });
  });
  var wptApiKeyInput = document.getElementById("wptApiKey");
  wptApiKeyInput.addEventListener('change', (e) => {
    saveWPTAPIKey(wptApiKeyInput.value);
  });
  var form = document.getElementById('inputUrls');
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    var formData = new FormData(form);
    document.getElementById('output').style.display = 'block';
    let connection = (formData.get('connectionType') === "3G") ? "3GFast" : formData.get('connectionType');
    let device = formData.get('device');
    let wptApiKey = formData.get('wptApiKey');
    let testInfo = {
      canonical: { url: AMPUrlsJson.ampUrls[0].originalUrl, label: 'Canonical', run: false },
      origin: { url: AMPUrlsJson.ampUrls[0].ampUrl, label: 'AMP Origin', run: false },
      cache: { url: AMPUrlsJson.ampUrls[0].cdnAmpUrl, label: 'AMP Cache', run: false },
      serp: { url: formData.get('searchTerm'), label: 'AMP SERP', run: false },
    };
    // run all tests
    var promises = [];
    document.querySelectorAll('.checkbox').forEach(check => {
      if (check.checked) {
        if (check.value === "serp")
          promises.push(runScriptedWPT(testInfo[check.value].url, testInfo.origin.url, connection, check.value, wptApiKey));
        else
          promises.push(runWPT(testInfo[check.value].url, connection, check.value, wptApiKey));
      }
    });
    // after tests have kicked off, populate links
    let first = true;
    Promise.all(promises).then(values => {
      let compareVideosURL = `https://www.webpagetest.org/video/compare.php?tests=`;
      values.forEach(val => {
        if (!first) compareVideosURL += `,`;
        first = false;
        compareVideosURL += `${val.id}-l:${testInfo[val.name].label}-c:0`;
        document.getElementById(`${val.name}WPTLink`).innerHTML = `<a target="_blank" href='https://www.webpagetest.org/result/${val.id}'>WPT Link</a>`;
      });
      compareVideosURL += `&ival=1000`;
      document.getElementById('comparisonLink').href = compareVideosURL;
      document.getElementById('wptiframe').src = compareVideosURL;
      saveTest(testInfo.canonical.url, compareVideosURL);
      gtag('event', 'Run Test', {
        'event_category': `${connection}`,
        'event_label': `url=${testInfo.canonical.url}&searchTerm=${testInfo.serp.url}&link=${compareVideosURL}`
      });
    });
    document.getElementById('canonicalUrl').innerHTML = `<code><a href='${testInfo.canonical.url}'>${testInfo.canonical.url}</a></code>`;
    document.getElementById('originUrl').innerHTML = `<code><a href='${testInfo.origin.url}'>${testInfo.origin.url}</a></code>`;
    document.getElementById('cacheUrl').innerHTML = `<code><a href='${testInfo.cache.url}'>${testInfo.cache.url}</a></code>`;
  });
  </script>
</body>

</html>
